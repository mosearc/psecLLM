name: Obfusk8 Pipeline

on:
  push:
    paths:
      - 'src/**.cpp'
      - 'src/**.cxx'
      - 'src/**.cc'
  workflow_dispatch:

jobs:
  obfusk8-build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone Obfusk8 headers
        run: |
          git clone https://github.com/x86byte/Obfusk8.git C:\Obfusk8

      - name: Verify Obfusk8 structure
        shell: cmd
        run: |
          echo === Locating Obfusk8Core.hpp ===
          dir /s /b C:\Obfusk8\*Obfusk8Core.hpp

      - name: Set up MSVC environment
        uses: microsoft/setup-msbuild@v2

      - name: Find and compile all C++ sources with Obfusk8
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat" 2>nul
          if errorlevel 1 call "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat" 2>nul
          if errorlevel 1 call "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat" 2>nul

          if not exist obfuscated mkdir obfuscated

          for %%f in (src\*.cpp src\*.cxx src\*.cc) do (
            echo.
            echo [Obfusk8] Compiling %%f ...
            cl.exe /std:c++17 /EHsc /O2 ^
              /I"C:\Obfusk8\Obfusk8\Instrumentation\materialization\state" ^
              /I"C:\Obfusk8\Obfusk8\Instrumentation\materialization\transform" ^
              /I"C:\Obfusk8\Obfusk8\Instrumentation\materialization" ^
              /I"C:\Obfusk8\Obfusk8\Instrumentation" ^
              /I"C:\Obfusk8\Obfusk8" ^
              /I"C:\Obfusk8" ^
              "%%f" ^
              /Fe:"obfuscated\%%~nf_obfusk8.exe"

            if errorlevel 1 (
              echo [FAIL] %%f
              exit /b 1
            )
            echo [OK] obfuscated\%%~nf_obfusk8.exe
          )

      - name: Run obfuscated binaries (smoke test)
        shell: cmd
        run: |
          for %%f in (obfuscated\*.exe) do (
            echo.
            echo [RUN] %%f
            "%%f"
            if errorlevel 1 (
              echo [FAIL] %%f exited with error
              exit /b 1
            )
            echo [OK] %%f
          )

      - name: Upload obfuscated binaries
        uses: actions/upload-artifact@v4
        with:
          name: obfusk8-binaries
          path: obfuscated/*.exe
          retention-days: 30
