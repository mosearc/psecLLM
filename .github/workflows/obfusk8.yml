name: Obfusk8 Pipeline

on:
  push:
    paths:
      - 'src/**.cpp'
      - 'src/**.cxx'
      - 'src/**.cc'
  workflow_dispatch:
    inputs:
      profile:
        description: 'Obfuscation profile'
        required: false
        default: 'medium'
        type: choice
        options:
          - light
          - medium
          - heavy

jobs:
  obfusk8-build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Obfusk8 headers
        uses: actions/cache@v4
        with:
          path: C:\Obfusk8
          key: obfusk8-${{ hashFiles('.github/workflows/obfusk8.yml') }}

      - name: Clone Obfusk8 headers
        shell: cmd
        run: |
          if not exist C:\Obfusk8 (
            git clone https://github.com/x86byte/Obfusk8.git C:\Obfusk8
          ) else (
            echo Obfusk8 headers already cached.
          )

      - name: Verify Obfusk8 structure
        shell: cmd
        run: |
          echo === Locating Obfusk8Core.hpp ===
          dir /s /b C:\Obfusk8\*Obfusk8Core.hpp

      - name: Set up MSVC environment
        uses: microsoft/setup-msbuild@v2

      - name: Resolve compiler flags from profile
        shell: bash
        run: |
          PROFILE="${{ github.event.inputs.profile || 'medium' }}"
          echo "Using profile: $PROFILE"
          case $PROFILE in
            light)  echo "MSVC_FLAGS=/Od /EHsc /std:c++17" >> $GITHUB_ENV ;;
            medium) echo "MSVC_FLAGS=/O1 /EHsc /std:c++17" >> $GITHUB_ENV ;;
            heavy)  echo "MSVC_FLAGS=/O2 /GL /Oy /GS- /EHsc /std:c++17" >> $GITHUB_ENV ;;
            *)      echo "MSVC_FLAGS=/Od /EHsc /std:c++17" >> $GITHUB_ENV ;;
          esac

      - name: Find and compile all C++ sources with Obfusk8
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat" 2>nul
          if errorlevel 1 call "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat" 2>nul
          if errorlevel 1 call "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat" 2>nul

          if not exist obfuscated mkdir obfuscated

          for %%f in (src\*.cpp src\*.cxx src\*.cc) do (
            echo.
            echo [Obfusk8] Compiling %%f with flags: ${{ env.MSVC_FLAGS }}
            cl.exe ${{ env.MSVC_FLAGS }} ^
              /I"C:\Obfusk8\Obfusk8\Instrumentation\materialization\state" ^
              /I"C:\Obfusk8\Obfusk8\Instrumentation\materialization\transform" ^
              /I"C:\Obfusk8\Obfusk8\Instrumentation\materialization" ^
              /I"C:\Obfusk8\Obfusk8\Instrumentation" ^
              /I"C:\Obfusk8\Obfusk8" ^
              /I"C:\Obfusk8" ^
              "%%f" ^
              /Fe:"obfuscated\%%~nf_obfusk8.exe"

            if errorlevel 1 (
              echo [FAIL] %%f
              exit /b 1
            )
            echo [OK] obfuscated\%%~nf_obfusk8.exe
          )

      - name: Run obfuscated binaries (smoke test)
        shell: pwsh
        run: |
          $failed = 0
          Get-ChildItem -Path "obfuscated\*.exe" | ForEach-Object {
            Write-Host ""
            Write-Host "[RUN] $($_.Name)"
            & $_.FullName
            $output_exit = $LASTEXITCODE
            # printf returns number of chars written â€” treat anything under 1000 as success
            # a real crash returns negative or very large values
            if ($output_exit -lt 0 -or $output_exit -gt 1000) {
              Write-Host "[FAIL] $($_.Name) exited with unexpected code $output_exit"
              $failed = 1
            } else {
              Write-Host "[OK] $($_.Name) (exit code: $output_exit)"
            }
          }
          if ($failed -eq 1) { exit 1 }

      - name: Upload obfuscated binaries
        uses: actions/upload-artifact@v4
        with:
          name: obfusk8-binaries-${{ github.event.inputs.profile || 'medium' }}
          path: obfuscated/*.exe
          retention-days: 30
